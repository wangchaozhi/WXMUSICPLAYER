name: Build AppImage

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

jobs:
  build-appimage:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential pkg-config
          sudo apt-get install -y libgtk-3-dev
          sudo apt-get install -y wget file imagemagick

      - name: Install system dependencies
        run: |
          # 尝试安装wxWidgets开发包，如果3.2不存在则尝试3.0
          sudo apt-get install -y libsdl2-dev libsdl2-mixer-dev
          sudo apt-get install -y libwxgtk3.2-dev || sudo apt-get install -y libwxgtk3.0-dev || sudo apt-get install -y libwxgtk3.1-dev

      - name: Install AppImage tools
        run: |
          # 安装FUSE支持
          sudo apt-get install -y fuse
          # 下载AppImage工具（使用稳定版本）
          wget -c "https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool
          # 加载FUSE模块
          sudo modprobe fuse || true
          # 检查FUSE是否可用
          lsmod | grep fuse || echo "FUSE module not loaded, but continuing..."

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/lib

      - name: Build application
        run: |
          mkdir build
          cd build
          # 使用动态链接，但确保兼容性
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          make -j$(nproc)

      - name: Copy executable and dependencies
        run: |
          # Copy the main executable
          cp build/bin/wxmusicplayer AppDir/usr/bin/
          chmod +x AppDir/usr/bin/wxmusicplayer

          # Copy all dependencies using ldd with better error handling
          echo "Copying dependencies..."
          ldd build/bin/wxmusicplayer | grep -v linux-vdso | grep -v ld-linux | awk '{print $3}' | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              # Skip system core libraries that should not be copied
              libname=$(basename "$lib")
              if [[ "$libname" =~ ^(libc\.|libm\.|libgcc_s\.|libstdc\+\+\.|ld-linux|libpthread\.|libdl\.|libutil\.|libgomp\.|libatomic\.|libquadmath\.|libgfortran\.|libgcc_s_|libstdc\+\+_|libmvec\.) ]]; then
                echo "Skipping system library: $lib"
                continue
              fi
              echo "Copying: $lib"
              cp "$lib" AppDir/usr/lib/ 2>/dev/null || echo "Failed to copy: $lib"
            fi
          done

          # Also copy wxWidgets libraries specifically
          echo "Copying wxWidgets libraries..."
          find /usr/lib -name "libwx_gtk3u_*.so*" -exec cp {} AppDir/usr/lib/ \; 2>/dev/null || true
          find /usr/lib/x86_64-linux-gnu -name "libwx_gtk3u_*.so*" -exec cp {} AppDir/usr/lib/ \; 2>/dev/null || true

          # List what we copied
          echo "Libraries in AppDir/usr/lib/:"
          ls -la AppDir/usr/lib/ || echo "No libraries found"

      - name: Create desktop file
        run: |
          cat > AppDir/usr/share/applications/wxmusicplayer.desktop << EOF
          [Desktop Entry]
          Name=wxMusicPlayer
          GenericName=Music Player
          Comment=Simple music player built with wxWidgets
          Exec=wxmusicplayer
          Icon=wxmusicplayer
          Terminal=false
          Type=Application
          Categories=AudioVideo;Audio;Player;
          Keywords=music;player;audio;wxwidgets;
          EOF

      - name: Create icon
        run: |
          # Create a simple icon
          convert -size 256x256 xc:transparent -fill "#4A90E2" -draw "circle 128,128 128,64" \
                  -fill white -pointsize 60 -gravity center -annotate +0+0 "🎵" \
                  AppDir/usr/share/icons/hicolor/256x256/apps/wxmusicplayer.png

      - name: Create AppRun script
        run: |
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export PATH="${HERE}"/usr/bin/:"${PATH}"
          export LD_LIBRARY_PATH="${HERE}"/usr/lib/:"${LD_LIBRARY_PATH}"

          # Debug: show what libraries are available
          echo "Available libraries in ${HERE}/usr/lib/:"
          ls -la "${HERE}"/usr/lib/ 2>/dev/null || echo "No libraries found"

          # Check if executable exists
          if [ ! -f "${HERE}/usr/bin/wxmusicplayer" ]; then
            echo "Error: wxmusicplayer executable not found!"
            exit 1
          fi

          # Show library dependencies
          echo "Library dependencies:"
          ldd "${HERE}/usr/bin/wxmusicplayer" 2>/dev/null || echo "Failed to check dependencies"

          exec "${HERE}"/usr/bin/wxmusicplayer "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          # 复制运行脚本到AppDir
          cp run_linux.sh AppDir/
          chmod +x AppDir/run_linux.sh

          # 检查AppDir内容
          echo "AppDir contents:"
          find AppDir -type f -executable

          # 尝试构建AppImage
          echo "Building AppImage..."
          if appimagetool AppDir wxMusicPlayer-x86_64.AppImage; then
            echo "AppImage构建成功！"
          else
            echo "AppImage构建失败，错误代码: $?"
            echo "创建tar.gz包作为替代"
            # 创建tar.gz包
            tar -czf wxMusicPlayer-Linux-x86_64.tar.gz -C AppDir .
            echo "tar.gz包创建完成"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wxMusicPlayer-Linux
          path: |
            wxMusicPlayer-x86_64.AppImage
            wxMusicPlayer-Linux-x86_64.tar.gz
          if-no-files-found: error

      - name: Create release on tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wxMusicPlayer-x86_64.AppImage
            wxMusicPlayer-Linux-x86_64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
