name: Build AppImage

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          echo "å¼€å§‹è®¾ç½®æ„å»ºç¯å¢ƒ..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq cmake build-essential pkg-config
          sudo apt-get install -y -qq libgtk-3-dev
          sudo apt-get install -y -qq wget file imagemagick
          echo "æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ"

      - name: Install system dependencies
        run: |
          echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get install -y -qq libsdl2-dev libsdl2-mixer-dev
          # å®‰è£…éŸ³é¢‘åº“
          sudo apt-get install -y -qq libasound2-dev libpulse-dev
          # å°è¯•å®‰è£…wxWidgetså¼€å‘åŒ…ï¼Œä½¿ç”¨æ­£ç¡®çš„åŒ…å
          sudo apt-get install -y -qq libwxgtk3.0-gtk3-dev || sudo apt-get install -y -qq libwxgtk3.0-dev || sudo apt-get install -y -qq wx3.0-headers
          echo "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install AppImage tools
        run: |
          echo "ğŸ“¦ å®‰è£…AppImageå·¥å…·..."
          # å®‰è£…FUSEæ”¯æŒ
          sudo apt-get install -y -qq fuse3 libfuse2
          # ä¸‹è½½AppImageå·¥å…·ï¼ˆä½¿ç”¨ç¨³å®šç‰ˆæœ¬ï¼‰
          wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool
          # æ£€æŸ¥FUSE
          ls -la /dev/fuse || echo "FUSEè®¾å¤‡ä¸å­˜åœ¨"
          lsmod | grep fuse || echo "FUSEæ¨¡å—æœªåŠ è½½"
          # æ£€æŸ¥AppImageå·¥å…·
          appimagetool --version || echo "AppImageå·¥å…·ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          echo "âœ… AppImageå·¥å…·å®‰è£…å®Œæˆ"

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/lib

      - name: Build application
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨ç¨‹åº..."
          mkdir build
          cd build
          # ä½¿ç”¨åŠ¨æ€é“¾æ¥ï¼Œä½†ç¡®ä¿å…¼å®¹æ€§
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          echo "âš™ï¸  é…ç½®å®Œæˆï¼Œå¼€å§‹ç¼–è¯‘..."
          make -j$(nproc)
          echo "âœ… åº”ç”¨ç¨‹åºæ„å»ºå®Œæˆ"

      - name: Copy executable and dependencies
        run: |
          # Copy the main executable
          cp build/bin/wxmusicplayer AppDir/usr/bin/
          chmod +x AppDir/usr/bin/wxmusicplayer

          # Copy all dependencies using ldd with better error handling
          echo "Copying dependencies..."
          ldd build/bin/wxmusicplayer | grep -v linux-vdso | grep -v ld-linux | awk '{print $3}' | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              # Skip system core libraries that should not be copied
              libname=$(basename "$lib")
              if [[ "$libname" =~ ^(libc\.|libm\.|libgcc_s\.|libstdc\+\+\.|ld-linux|libpthread\.|libdl\.|libutil\.|libgomp\.|libatomic\.|libquadmath\.|libgfortran\.|libgcc_s_|libstdc\+\+_|libmvec\.) ]]; then
                echo "Skipping system library: $lib"
                continue
              fi
              echo "Copying: $lib"
              cp "$lib" AppDir/usr/lib/ 2>/dev/null || echo "Failed to copy: $lib"
            fi
          done

          # Also copy wxWidgets libraries specifically
          echo "Copying wxWidgets libraries..."
          find /usr/lib -name "libwx_gtk3u_*.so*" -exec cp {} AppDir/usr/lib/ \; 2>/dev/null || true
          find /usr/lib/x86_64-linux-gnu -name "libwx_gtk3u_*.so*" -exec cp {} AppDir/usr/lib/ \; 2>/dev/null || true

          # List what we copied
          echo "Libraries in AppDir/usr/lib/:"
          ls -la AppDir/usr/lib/ || echo "No libraries found"

      - name: Create desktop file
        run: |
          cat > AppDir/usr/share/applications/wxmusicplayer.desktop << EOF
          [Desktop Entry]
          Name=wxMusicPlayer
          GenericName=Music Player
          Comment=Simple music player built with wxWidgets
          Exec=wxmusicplayer
          Icon=wxmusicplayer
          Terminal=false
          Type=Application
          Categories=AudioVideo;Audio;Player;
          Keywords=music;player;audio;wxwidgets;
          EOF

      - name: Create icon
        run: |
          # Create a simple icon using basic shapes
          convert -size 256x256 xc:transparent -fill "#4A90E2" -draw "circle 128,128 128,64" \
                  -fill "#2E5C8A" -draw "circle 128,128 100,50" \
                  AppDir/usr/share/icons/hicolor/256x256/apps/wxmusicplayer.png

      - name: Create AppRun script
        run: |
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export PATH="${HERE}"/usr/bin/:"${PATH}"
          export LD_LIBRARY_PATH="${HERE}"/usr/lib/:"${LD_LIBRARY_PATH}"

          # Debug: show what libraries are available
          echo "Available libraries in ${HERE}/usr/lib/:"
          ls -la "${HERE}"/usr/lib/ 2>/dev/null || echo "No libraries found"

          # Check if executable exists
          if [ ! -f "${HERE}/usr/bin/wxmusicplayer" ]; then
            echo "Error: wxmusicplayer executable not found!"
            exit 1
          fi

          # Show library dependencies
          echo "Library dependencies:"
          ldd "${HERE}/usr/bin/wxmusicplayer" 2>/dev/null || echo "Failed to check dependencies"

          exec "${HERE}"/usr/bin/wxmusicplayer "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          echo "ğŸ“¦ å¼€å§‹æ„å»ºAppImage..."
          # å¤åˆ¶è¿è¡Œè„šæœ¬åˆ°AppDir
          cp run_linux.sh AppDir/
          chmod +x AppDir/run_linux.sh

          # æ£€æŸ¥AppDirå†…å®¹
          echo "ğŸ“ AppDirå†…å®¹:"
          find AppDir -type f -executable

          # é¦–å…ˆåˆ›å»ºtar.gzåŒ…ä½œä¸ºå¤‡ç”¨
          echo "ğŸ“¦ åˆ›å»ºtar.gzåŒ…..."
          tar -czf wxMusicPlayer-Linux-x86_64.tar.gz -C AppDir .
          echo "âœ… tar.gzåŒ…åˆ›å»ºå®Œæˆ"

          # å°è¯•æ„å»ºAppImage
          echo "ğŸ”¨ æ„å»ºAppImage..."
          # å°è¯•ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ„å»ºAppImage
          if appimagetool AppDir wxMusicPlayer-x86_64.AppImage; then
            echo "ğŸ‰ AppImageæ„å»ºæˆåŠŸï¼"
          else
            echo "âš ï¸  AppImageæ„å»ºå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨--no-fuseé€‰é¡¹..."
            if appimagetool --no-fuse AppDir wxMusicPlayer-x86_64.AppImage; then
              echo "ğŸ‰ AppImageæ„å»ºæˆåŠŸï¼ˆæ— FUSEæ¨¡å¼ï¼‰ï¼"
            else
              echo "âš ï¸  AppImageæ„å»ºå®Œå…¨å¤±è´¥ï¼Œé”™è¯¯ä»£ç : $?"
              echo "ğŸ“¦ å·²åˆ›å»ºtar.gzåŒ…ä½œä¸ºæ›¿ä»£"
            fi
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wxMusicPlayer-Linux
          path: |
            wxMusicPlayer-Linux-x86_64.tar.gz
            wxMusicPlayer-x86_64.AppImage
          if-no-files-found: error

      - name: Create release on tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wxMusicPlayer-x86_64.AppImage
            wxMusicPlayer-Linux-x86_64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
